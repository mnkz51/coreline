name: Gemini Auto Coder
on:
  push:
    paths:
      - 'SPEC.md'

jobs:
  code-gen:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Gemini AI Coding
        uses: google-github-actions/run-gemini-cli@v0
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          gemini_model: 'gemini-2.5-flash'
          prompt: |
            あなたは「Core-Line」というブラウザゲームのリード開発者です。
            
            【設計方針】
            1. 外部ライブラリ（グリッド用）は不使用。Red Blob Gamesの「Cube Coordinates」に基づいた自作のHex管理クラスを実装する。
            2. 描画は PixiJS を使用。
            3. ビルドツール（npm/webpack等）は使わず、ブラウザでそのまま動く「JavaScript (ES modules)」で記述してください。
            4. コードは index.html と script.js の2ファイルに分けて出力してください。
            5. ロジックと描画を分離し、将来的な機能拡張（自動化・物流）に耐えうるクリーンなコードを書いてください。
            
            【厳守事項】
            1. 成果物の content は、必ず Base64 形式に変換してください。
            2. 自然言語の解説は一切含めず、純粋なJSONのみを返してください。
            3. 回答の最後には、必ず以下の形式でファイルをまとめてください。
            
            ```json
            {
              "files": [
                {"path": "index.html", "content": "(Base64 encoded string)"},
                {"path": "script.js", "content": "(Base64 encoded string)"}
              ]
            }
            ```
            
            【現在のタスク】
            SPEC.md の「現在の目標」を確認し、それを実現するための index.html および script.js の全内容を、それぞれマークダウンのコードブロック形式で出力してください。

      - name: Process JSON with jq and base64
        run: |
          sed -n '/```json/,/```/p' gemini-artifacts/stdout.log | sed '1d;$d' > extracted.json
          
          jq -c '.files[]' extracted.json | while read -r file; do
            FILE_PATH=$(echo "$file" | jq -r '.path')
            CONTENT_B64=$(echo "$file" | jq -r '.content')
            
            mkdir -p "$(dirname "$FILE_PATH")"
            echo "$CONTENT_B64" | base64 --decode > "$FILE_PATH"
            
            echo "Successfully restored: $FILE_PATH"
          done

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "Update code based on latest SPEC.md"
          title: "Gemini: SPEC.mdの内容を反映しました"
          body: "コードを生成しました。動作確認をお願いします。"
          branch: gemini-updates
          delete-branch: true
